#########generelize server##########
sudo waagent -deprovision+user


#########create template from generelized server###########
link:  https://docs.microsoft.com/en-us/azure/virtual-machines/linux/capture-image?toc=%2Fazure%2Fvirtual-machines%2Flinux%2Ftoc.json

Use the Azure CLI 2.0 to mark the VM as generalized and capture the image. In the following examples, replace example parameter names with your own values. Example parameter names include myResourceGroup, myVnet, and myVM.

Deallocate the VM that you deprovisioned with az vm deallocate. The following example deallocates the VM named myVM in the resource group named myResourceGroup:

Azure CLI

Copy
az vm deallocate \
  --resource-group myResourceGroup \
  --name myVM
Mark the VM as generalized with az vm generalize. The following example marks the VM named myVM in the resource group named myResourceGroup as generalized:

Azure CLI

Copy
az vm generalize \
  --resource-group myResourceGroup \
  --name myVM
Now create an image of the VM resource with az image create. The following example creates an image named myImage in the resource group named myResourceGroup using the VM resource named myVM:

Azure CLI

Copy
az image create \
  --resource-group myResourceGroup \
  --name myImage --source myVM



##########install waagent##############
http://blog.admindiary.com/install-microsoft-azure-linux-agent-waagent/